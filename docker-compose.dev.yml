services:
  postgres:
    image: postgres:16-alpine
    container_name: noteapp_postgres_dev
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-noteapp_db}
      POSTGRES_USER: ${POSTGRES_USER:-noteapp_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-noteapp_password}
    volumes:
      - postgres_data_dev:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-noteapp_user} -d ${POSTGRES_DB:-noteapp_db}"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s
    networks:
      - noteapp_network_dev

  redis:
    image: redis:7-alpine
    container_name: noteapp_redis_dev
    command: redis-server ${REDIS_PASSWORD:+--requirepass $REDIS_PASSWORD}
    volumes:
      - redis_data_dev:/data
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 5s
    networks:
      - noteapp_network_dev

  api:
    build:
      context: ./backend
      dockerfile: Dockerfile.dev
      cache_from:
        - noteapp-api-dev:latest
    image: noteapp-api-dev:latest
    container_name: noteapp_api_dev
    volumes:
      # Mount source code for hot-reload (cached for better performance on macOS)
      - ./backend:/app:cached
      # Prevent __pycache__ pollution on host
      - /app/__pycache__
      # Named volume for Poetry cache to speed up dependency installs
      - poetry_cache:/root/.cache/pypoetry
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-noteapp_user}:${POSTGRES_PASSWORD:-noteapp_password}@postgres:5432/${POSTGRES_DB:-noteapp_db}
      REDIS_URL: redis://redis:6379/0
      CELERY_BROKER_URL: redis://redis:6379/1
      SECRET_KEY: ${SECRET_KEY:-dev-secret-key-change-in-production}
      DEBUG: "True"
      DJANGO_SETTINGS_MODULE: api.settings.development
      ALLOWED_HOSTS: ${ALLOWED_HOSTS:-localhost,127.0.0.1,api}
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-http://localhost:3000}
      DJANGO_SUPERUSER_USERNAME: ${DJANGO_SUPERUSER_USERNAME:-}
      DJANGO_SUPERUSER_PASSWORD: ${DJANGO_SUPERUSER_PASSWORD:-}
      DJANGO_SUPERUSER_EMAIL: ${DJANGO_SUPERUSER_EMAIL:-}
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: ${POSTGRES_USER:-noteapp_user}
      DB_NAME: ${POSTGRES_DB:-noteapp_db}
    ports:
      - "8000:8000"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    # Use init for proper signal handling (clean shutdowns)
    init: true
    # Django dev server auto-reloads on code changes
    command: python manage.py runserver 0.0.0.0:8000
    networks:
      - noteapp_network_dev

  celery_worker:
    build:
      context: ./backend
      dockerfile: Dockerfile.dev
      cache_from:
        - noteapp-api-dev:latest
    image: noteapp-api-dev:latest
    container_name: noteapp_celery_worker_dev
    volumes:
      # Same volume mounts as api service
      - ./backend:/app:cached
      - /app/__pycache__
      - poetry_cache:/root/.cache/pypoetry
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-noteapp_user}:${POSTGRES_PASSWORD:-noteapp_password}@postgres:5432/${POSTGRES_DB:-noteapp_db}
      REDIS_URL: redis://redis:6379/0
      CELERY_BROKER_URL: redis://redis:6379/1
      SECRET_KEY: ${SECRET_KEY:-dev-secret-key-change-in-production}
      DEBUG: "True"
      DJANGO_SETTINGS_MODULE: api.settings.development
      SKIP_MIGRATIONS: "true"
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: ${POSTGRES_USER:-noteapp_user}
      DB_NAME: ${POSTGRES_DB:-noteapp_db}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      api:
        condition: service_started
    init: true
    # Use watchdog for auto-restart on Python file changes
    command: watchmedo auto-restart --directory=/app --pattern="*.py" --recursive -- celery -A api worker --loglevel=info
    networks:
      - noteapp_network_dev

volumes:
  postgres_data_dev:
    driver: local
  redis_data_dev:
    driver: local
  poetry_cache:
    driver: local

networks:
  noteapp_network_dev:
    driver: bridge
