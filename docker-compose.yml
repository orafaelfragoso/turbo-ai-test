services:
  postgres:
    image: postgres:16-alpine
    container_name: noteapp_postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-noteapp_db}
      POSTGRES_USER: ${POSTGRES_USER:-noteapp_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-noteapp_password}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    # Port not exposed in production for security - access via backend only
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-noteapp_user} -d ${POSTGRES_DB:-noteapp_db}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - noteapp_network

  redis:
    image: redis:7-alpine
    container_name: noteapp_redis
    command: redis-server ${REDIS_PASSWORD:+--requirepass $REDIS_PASSWORD}
    volumes:
      - redis_data:/data
    # Port not exposed in production for security - access via backend only
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - noteapp_network

  api:
    build:
      context: ./backend
      dockerfile: Dockerfile
    image: noteapp-api:latest
    container_name: noteapp_api
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-noteapp_user}:${POSTGRES_PASSWORD:-noteapp_password}@postgres:5432/${POSTGRES_DB:-noteapp_db}
      REDIS_URL: redis://redis:6379/0
      CELERY_BROKER_URL: redis://redis:6379/1
      SECRET_KEY: ${SECRET_KEY:-change-this-secret-key-in-production}
      DEBUG: ${DEBUG:-False}
      ALLOWED_HOSTS: ${ALLOWED_HOSTS:-localhost,127.0.0.1,api}
      GUNICORN_WORKERS: ${GUNICORN_WORKERS:-4}
      GUNICORN_THREADS: ${GUNICORN_THREADS:-2}
      JWT_ACCESS_TOKEN_LIFETIME: ${JWT_ACCESS_TOKEN_LIFETIME:-15}
      JWT_REFRESH_TOKEN_LIFETIME: ${JWT_REFRESH_TOKEN_LIFETIME:-10080}
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-http://localhost:3000}
      DJANGO_SUPERUSER_USERNAME: ${DJANGO_SUPERUSER_USERNAME:-}
      DJANGO_SUPERUSER_PASSWORD: ${DJANGO_SUPERUSER_PASSWORD:-}
      DJANGO_SUPERUSER_EMAIL: ${DJANGO_SUPERUSER_EMAIL:-}
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: ${POSTGRES_USER:-noteapp_user}
      DB_NAME: ${POSTGRES_DB:-noteapp_db}
    ports:
      - "8000:8000"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/health/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - noteapp_network

  celery_worker:
    # Reuse the same image as api service (no duplicate build)
    image: noteapp-api:latest
    container_name: noteapp_celery_worker
    command: celery -A api worker --loglevel=info
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-noteapp_user}:${POSTGRES_PASSWORD:-noteapp_password}@postgres:5432/${POSTGRES_DB:-noteapp_db}
      REDIS_URL: redis://redis:6379/0
      CELERY_BROKER_URL: redis://redis:6379/1
      SECRET_KEY: ${SECRET_KEY:-change-this-secret-key-in-production}
      DEBUG: ${DEBUG:-False}
      SKIP_MIGRATIONS: "true"
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: ${POSTGRES_USER:-noteapp_user}
      DB_NAME: ${POSTGRES_DB:-noteapp_db}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      api:
        condition: service_started
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - noteapp_network

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    image: noteapp-frontend:latest
    container_name: noteapp_frontend
    environment:
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://api:8000}
      NODE_ENV: production
    ports:
      - "3000:3000"
    depends_on:
      api:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - noteapp_network

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local

networks:
  noteapp_network:
    driver: bridge
